#include "llclose.h"

int llclose(int fd) {
	int res;

	//frame creation
	unsigned char DISC[5], DISC2[5];
	SET[0] = F;
	SET[1] = A;
	SET[2] = C;
	SET[3] = DISC[1] ^ DISC[2];
	SET[4] = F;

	//machine state periferal vars
	int stop = 1, estado = 0, res2;
	unsigned char c;

	//sending SET frame
	puts("Sending SET frame...");
	res = write(fd,SET,5);
	alarm(3);
	if(res != -1) {
		printf("%d bytes written\n", res);
	} else {
		puts("Connection establishment failed.");
		return 1;
	}
			
	printf("stop: %d\nconnecting: %d", stop, connecting);
			
	//receiving UA frame
	puts("Reading UA frame...");
	while(stop){
		puts("Reading...");
		res = read(fd,&c,1);
		if(res > 0) {
			alarm(0);
			switch(estado){
				case 0: {
					printf("estado 0\n");
					if (c == F){
						DISC2[0] = c;
						estado = 1;
					}
					break;
				}
				case 1:{
					printf("estado 1\n");
					if (c == A){
						DISC2[1] = c;
							estado = 2;
					} else if (c == F){
						estado = 1;
						DISC2[0] = c;
					} else 
						estado = 0;
					break;	
				}
				case 2:{				
					printf("estado 2\n");
					if (c == CS){
						DISC2[2] = c;
						estado = 3;
					} else if (c == F){
						UA[0] = c;
						estado = 1;
					} else
						estado = 0; 
					break;
				}
				case 3:{
					printf("estado 3\n");
					if (c == (UA[1] ^ UA[2])){
						UA[3] = c;
						estado = 4;
					} else if (c == F){
						UA[0] = c;
						estado = 1;
					} else 
						estado = 0;
					break;
				}
				case 4:{
					printf("estado 4\n");
					if (c == F){
						UA[4] = c;
						if (UA[0] == F && UA[1] == A && UA[2] == CS && UA[3] == (UA[1] ^ UA[2]) && UA[4] == F){
							puts("Received UA frame successfully.");
							stop = 0;
							puts("Finished reading.");
							break;
						} else {
							puts("UA frame is wrong, somehow.");
							estado = 0;
						}
					} else
						estado = 0;
					break;
				}
			}
		}

		if(estado == 4)
			break;
	}

	return 0;
}
